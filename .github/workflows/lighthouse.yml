name: Lighthouse CI

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  lighthouse:
    name: Lighthouse PWA Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        run: npm run build
      
      - name: Serve application
        run: |
          npm install -g serve
          serve -s dist -l 8080 &
          sleep 5
      
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            http://localhost:8080
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3
      
      - name: Check Lighthouse scores
        run: |
          echo "Lighthouse audit completed"
          echo "Check the results in the action artifacts"
          echo ""
          echo "Target scores:"
          echo "- Performance: > 90"
          echo "- Accessibility: > 90"
          echo "- Best Practices: > 90"
          echo "- SEO: > 90"
          echo "- PWA: > 90"

  pwa-validation:
    name: PWA Requirements Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate manifest.json
        run: |
          echo "Validating PWA manifest..."
          
          # Check if manifest exists
          if [ ! -f "manifest.json" ]; then
            echo "❌ manifest.json not found"
            exit 1
          fi
          
          # Basic validation using Node.js
          node -e "
          const fs = require('fs');
          const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
          
          const required = ['name', 'short_name', 'start_url', 'display', 'icons'];
          const missing = required.filter(field => !manifest[field]);
          
          if (missing.length > 0) {
            console.error('❌ Missing required fields:', missing.join(', '));
            process.exit(1);
          }
          
          console.log('✅ Manifest validation passed');
          console.log('- Name:', manifest.name);
          console.log('- Short name:', manifest.short_name);
          console.log('- Display:', manifest.display);
          console.log('- Icons:', manifest.icons.length, 'icon(s)');
          "
      
      - name: Validate service worker
        run: |
          echo "Validating service worker..."
          
          if [ ! -f "sw.js" ]; then
            echo "❌ sw.js not found"
            exit 1
          fi
          
          echo "✅ Service worker found"
          
          # Check for common service worker patterns
          if grep -q "self.addEventListener" sw.js; then
            echo "✅ Event listeners found"
          fi
          
          if grep -q "caches" sw.js; then
            echo "✅ Cache API usage found"
          fi
      
      - name: Check for HTTPS requirements
        run: |
          echo "Checking HTTPS requirements..."
          echo "⚠️  Remember: PWAs require HTTPS in production"
          echo "✅ Development server uses HTTP (acceptable for localhost)"

  web-vitals:
    name: Web Vitals Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        run: npm run build
      
      - name: Check bundle size
        run: |
          echo "Checking bundle sizes..."
          
          if [ -d "dist/assets" ]; then
            echo "JavaScript bundles:"
            find dist/assets -name "*.js" -exec ls -lh {} \; | awk '{print $9, $5}'
            
            echo ""
            echo "CSS bundles:"
            find dist/assets -name "*.css" -exec ls -lh {} \; | awk '{print $9, $5}'
            
            # Check total dist size
            echo ""
            echo "Total dist size:"
            du -sh dist/
          fi
      
      - name: Performance recommendations
        run: |
          echo "Performance best practices:"
          echo "- Keep JavaScript bundles under 500KB (gzipped)"
          echo "- Implement code splitting for large applications"
          echo "- Use lazy loading for routes and components"
          echo "- Optimize images and assets"
          echo "- Minimize CSS and JavaScript"
